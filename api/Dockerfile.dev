FROM golang:1.24-alpine

# Installation des outils
RUN apk add --no-cache git curl build-base

# Installation d'Air (même si on ne l'utilise plus, au cas où)
#RUN go install github.com/air-verse/air@latest

WORKDIR /app

# Variables d'environnement pour Go
ENV GO111MODULE=on
ENV CGO_ENABLED=0

# Copie du code
COPY . .

# Download des dépendances
RUN go work sync

# Création des dossiers nécessaires
RUN mkdir -p tmp

# Test de compilation pour vérifier que tout fonctionne
RUN echo "=== Test compilation gateway ===" && \
    cd gateway && go build -o ../tmp/test-gateway ./cmd/gateway && \
    rm ../tmp/test-gateway && \
    echo "Gateway compilation OK"

RUN echo "=== Test compilation auth ===" && \
    cd services/auth && go build -o ../../tmp/test-auth ./cmd/server && \
    rm ../../tmp/test-auth && \
    echo "Auth compilation OK"

RUN echo "=== Test compilation property ===" && \
    cd services/property && go build -o ../../tmp/test-property ./cmd/server && \
    rm ../../tmp/test-property && \
    echo "Property compilation OK"

RUN echo "=== Test compilation tenant ===" && \
    cd services/tenant && go build -o ../../tmp/test-tenant ./cmd/server && \
    rm ../../tmp/test-tenant && \
    echo "Tenant compilation OK"

RUN echo "=== Test compilation shared ===" && \
    cd shared && go build -o ../tmp/test-shared ./cmd/server && \
    rm ../tmp/test-shared && \
    echo "Shared compilation OK"

EXPOSE 8080

RUN echo "=== DEBUG: Structure copiée ===" && \
    pwd && \
    ls -la && \
    echo "=== Gateway exists? ===" && \
    ls -la gateway/ 2>/dev/null || echo "Gateway folder missing!" && \
    echo "=== Services exists? ===" && \
    ls -la services/ 2>/dev/null || echo "Services folder missing!"

#CMD ["sh", "-c", "go mod tidy && go mod download && go run ./cmd/api"]
#CMD ["air", "-c", ".air.toml"]
#CMD ["sh", "-c", "go work sync && go run ./api-gateway/cmd/gateway"]
CMD ["sh", "-c", "cd gateway && go mod tidy && go mod download && go run ./cmd/gateway"]